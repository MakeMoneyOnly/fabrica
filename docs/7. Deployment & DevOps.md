# Fabrica - Deployment & DevOps Guide

**Version:** 1.0  
**Last Updated:** November 19, 2025  
**Target:** Production Deployment on Vercel + Supabase  
**Status:** Production-Ready

---

## 1. Overview

This guide covers the complete deployment pipeline for Fabrica, from local development to production, including CI/CD, monitoring, and incident response.

### Deployment Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   USERS (Ethiopia)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Cloudflare (CDN + DDoS Protection)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Vercel Edge Network (Next.js Hosting)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Edge 1   â”‚  â”‚   Edge 2   â”‚  â”‚   Edge 3   â”‚        â”‚
â”‚  â”‚  (Africa)  â”‚  â”‚  (Europe)  â”‚  â”‚   (Asia)   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚              â”‚              â”‚
        â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase   â”‚ â”‚   Clerk    â”‚ â”‚  Telebirr    â”‚
â”‚  (Database)  â”‚ â”‚   (Auth)   â”‚ â”‚  (Payment)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Environment Setup

### 2.1 Environments

| Environment    | Purpose        | URL                    | Branch     |
| -------------- | -------------- | ---------------------- | ---------- |
| **Local**      | Development    | localhost:3000         | N/A        |
| **Preview**    | PR testing     | preview-xxx.vercel.app | feature/\* |
| **Staging**    | Pre-production | staging.fabrica.et     | staging    |
| **Production** | Live site      | fabrica.et             | main       |

### 2.2 Environment Variables

**Required for All Environments:**

```bash
# Next.js
NEXT_PUBLIC_APP_URL=https://fabrica.et

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... # SECRET!

# Clerk
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_xxx
CLERK_SECRET_KEY=sk_live_xxx # SECRET!
CLERK_WEBHOOK_SECRET=whsec_xxx # SECRET!

# Telebirr
TELEBIRR_APP_ID=app_xxx
TELEBIRR_APP_KEY=xxx # SECRET!
TELEBIRR_MERCHANT_CODE=MERCHANT_XXX
TELEBIRR_WEBHOOK_SECRET=xxx # SECRET!
TELEBIRR_API_URL=https://api.telebirr.et/v2

# Resend (Email)
RESEND_API_KEY=re_xxx # SECRET!

# Sentry (Error Tracking)
NEXT_PUBLIC_SENTRY_DSN=https://xxx@sentry.io/xxx
SENTRY_AUTH_TOKEN=xxx # SECRET!

# PostHog (Analytics)
NEXT_PUBLIC_POSTHOG_KEY=phc_xxx
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com

# Upstash Redis (Rate Limiting)
UPSTASH_REDIS_REST_URL=https://xxx.upstash.io
UPSTASH_REDIS_REST_TOKEN=xxx # SECRET!

# Encryption
ENCRYPTION_KEY=xxx # SECRET! Generate with: openssl rand -hex 32
```

**Vercel Environment Configuration:**

1. Go to Vercel Dashboard â†’ Project Settings â†’ Environment Variables
2. Add all variables above
3. Set scope:
   - `NEXT_PUBLIC_*`: All environments
   - Secrets: Production only (override for staging/preview if different)

**Local Development (.env.local):**

```bash
# Copy .env.example to .env.local
cp .env.example .env.local

# Use development/sandbox credentials
TELEBIRR_API_URL=https://sandbox.telebirr.et/v2
TELEBIRR_APP_ID=test_app_123
# ...
```

---

## 3. CI/CD Pipeline

### 3.1 GitHub Actions Workflow

**File:** `.github/workflows/deploy.yml`

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run type-check

      - name: Unit tests
        run: npm run test

      - name: Build
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          # ... other build-time env vars

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true # Don't block on low-priority issues

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  deploy-preview:
    needs: [lint-and-test, security-scan]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel Preview
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          github-comment: true

  deploy-production:
    needs: [lint-and-test, security-scan]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Vercel Production
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          vercel-args: '--prod'

      - name: Run E2E tests (post-deployment)
        run: npm run test:e2e
        env:
          TEST_URL: https://fabrica.et

      - name: Notify team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'Deployment to production complete!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()

  database-migration:
    needs: deploy-production
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Supabase migrations
        run: |
          npx supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}
          npx supabase db push
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
```

### 3.2 Deployment Checklist

**Before Every Deployment:**

- [ ] All tests passing
- [ ] No lint errors or TypeScript errors
- [ ] `npm audit` shows no critical vulnerabilities
- [ ] Environment variables configured
- [ ] Database migrations ready (if any)
- [ ] Changelog updated
- [ ] Staging tested thoroughly

**After Deployment:**

- [ ] Verify homepage loads
- [ ] Test auth flow (signup/login)
- [ ] Test payment flow (sandbox if production)
- [ ] Check error rates in Sentry
- [ ] Verify webhooks receiving correctly
- [ ] Monitor performance metrics
- [ ] Check database connections

---

## 4. Database Migrations

### 4.1 Migration Workflow

**Creating a Migration:**

```bash
# Create new migration file
npx supabase migration new add_discount_codes

# This creates: supabase/migrations/20250119_add_discount_codes.sql
```

**Migration File Structure:**

```sql
-- supabase/migrations/20250119_add_discount_codes.sql

BEGIN;

-- 1. Create new table
CREATE TABLE discount_codes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  creator_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  code TEXT NOT NULL,
  discount_value DECIMAL(10,2) NOT NULL,
  -- ... rest of schema
);

-- 2. Create indexes
CREATE INDEX idx_discount_codes_creator ON discount_codes(creator_id);
CREATE INDEX idx_discount_codes_code ON discount_codes(code);

-- 3. Enable RLS
ALTER TABLE discount_codes ENABLE ROW LEVEL SECURITY;

-- 4. Create RLS policies
CREATE POLICY "Creators manage own codes"
  ON discount_codes FOR ALL
  USING (creator_id = (SELECT id FROM users WHERE clerk_user_id = auth.jwt() ->> 'sub'));

-- 5. Update related tables if needed
ALTER TABLE orders ADD COLUMN discount_code TEXT;

COMMIT;
```

**Testing Locally:**

```bash
# Apply migration locally
npx supabase db reset

# Test with seed data
npx supabase db seed
```

**Deploying Migration:**

```bash
# Link to production project
npx supabase link --project-ref YOUR_PROJECT_REF

# Push migration
npx supabase db push

# Verify in Supabase dashboard
```

### 4.2 Rollback Strategy

**If Migration Fails:**

1. **Automatic Rollback:** Wrap in `BEGIN; ... COMMIT;` transaction
2. **Manual Rollback:** Create rollback migration

```sql
-- supabase/migrations/20250119_rollback_discount_codes.sql
BEGIN;

-- Reverse changes
ALTER TABLE orders DROP COLUMN IF EXISTS discount_code;
DROP TABLE IF EXISTS discount_codes;

COMMIT;
```

**Zero-Downtime Migrations:**

For production with live traffic:

1. **Add new column (nullable):**

   ```sql
   ALTER TABLE products ADD COLUMN new_field TEXT;
   ```

2. **Deploy code that writes to both old and new:**

   ```typescript
   await supabase.from('products').update({
     old_field: value,
     new_field: value, // Write to both
   })
   ```

3. **Backfill data:**

   ```sql
   UPDATE products SET new_field = old_field WHERE new_field IS NULL;
   ```

4. **Switch reads to new column:**

   ```typescript
   // Deploy code that reads from new_field
   ```

5. **Drop old column:**
   ```sql
   ALTER TABLE products DROP COLUMN old_field;
   ```

---

## 5. Monitoring & Observability

### 5.1 Application Performance Monitoring

**Vercel Analytics (Built-in):**

- Core Web Vitals (LCP, FID, CLS)
- Real User Monitoring (RUM)
- API route performance
- Edge function metrics

**Access:** Vercel Dashboard â†’ Analytics

**Sentry Performance Monitoring:**

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  // Performance Monitoring
  tracesSampleRate: 0.1, // 10% of transactions

  integrations: [
    new Sentry.BrowserTracing({
      traceFetch: true,
      traceXHR: true,

      // Trace specific API routes
      tracingOrigins: ['localhost', 'fabrica.et', /^\//],
    }),
  ],

  beforeSend(event, hint) {
    // Redact sensitive data
    if (event.request) {
      delete event.request.cookies
    }
    return event
  },
})
```

**Key Metrics to Monitor:**

- API Response Time (p50, p95, p99)
- Error Rate (errors per 1000 requests)
- Page Load Time
- Database Query Time
- Payment Success Rate

### 5.2 Uptime Monitoring

**UptimeRobot Configuration:**

```
Monitor 1: Homepage
  URL: https://fabrica.et
  Type: HTTPS
  Interval: 5 minutes
  Alert: Email + Slack

Monitor 2: API Health Check
  URL: https://fabrica.et/api/health
  Type: HTTPS (Keyword: "healthy")
  Interval: 2 minutes
  Alert: PagerDuty (P0)

Monitor 3: Payment Webhook
  URL: https://fabrica.et/api/webhooks/telebirr/health
  Type: HTTPS
  Interval: 5 minutes
  Alert: Email + Slack
```

**Health Check Endpoint:**

```typescript
// app/api/health/route.ts
export async function GET() {
  const checks = {
    timestamp: new Date().toISOString(),
    status: 'healthy',
    checks: {
      database: false,
      storage: false,
      auth: false,
    },
  }

  try {
    // Check database
    const supabase = createClient()
    const { error } = await supabase.from('users').select('id').limit(1)
    checks.checks.database = !error

    // Check storage
    const { data: buckets } = await supabase.storage.listBuckets()
    checks.checks.storage = !!buckets

    // Check Clerk
    checks.checks.auth = !!process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY

    const allHealthy = Object.values(checks.checks).every((v) => v === true)

    return Response.json(checks, {
      status: allHealthy ? 200 : 503,
    })
  } catch (error) {
    return Response.json(
      {
        ...checks,
        status: 'unhealthy',
        error: 'Health check failed',
      },
      { status: 503 }
    )
  }
}
```

### 5.3 Logging Strategy

**Log Levels:**

- `ERROR`: Critical issues requiring immediate action
- `WARN`: Important but not critical
- `INFO`: General information
- `DEBUG`: Detailed debug information (dev only)

**Structured Logging:**

```typescript
// lib/logger.ts
import pino from 'pino'

const logger = pino({
  level: process.env.LOG_LEVEL || 'info',
  formatters: {
    level: (label) => ({ level: label }),
  },
  redact: {
    paths: ['*.password', '*.token', '*.apiKey', '*.phoneNumber'],
    remove: true,
  },
})

export function logPayment(event: {
  orderId: string
  amount: number
  status: string
  provider: string
}) {
  logger.info({
    event: 'payment_processed',
    orderId: event.orderId,
    amount: event.amount,
    status: event.status,
    provider: event.provider,
    timestamp: new Date().toISOString(),
  })
}

export function logError(error: Error, context?: Record<string, any>) {
  logger.error({
    error: {
      message: error.message,
      stack: error.stack,
      name: error.name,
    },
    context,
    timestamp: new Date().toISOString(),
  })
}
```

**Log Aggregation:**

- **Vercel Logs:** Automatic collection (7-day retention on Hobby plan)
- **Supabase Logs:** Edge Function logs
- **Sentry:** Error logs with context
- **Optional:** Better Stack (formerly Logtail) for long-term storage

---

## 6. Backup & Disaster Recovery

### 6.1 Automated Backups

**Supabase Backups:**

- **Daily automated backups** (7-day retention on Pro plan)
- **Point-in-Time Recovery** (PITR) - up to 7 days
- **Manual snapshots** before major changes

**Enable PITR:**

```bash
# Supabase Dashboard â†’ Database â†’ Backups â†’ Enable PITR
```

**Additional Backup Strategy:**

```bash
# Weekly full backup script
#!/bin/bash

# Backup database
pg_dump \
  -h db.xxx.supabase.co \
  -U postgres \
  -d postgres \
  -F c \
  -f "backup_$(date +%Y%m%d).dump"

# Upload to S3/R2
aws s3 cp backup_$(date +%Y%m%d).dump s3://fabrica-backups/

# Encrypt and store locally
gpg --encrypt --recipient backups@fabrica.et backup_$(date +%Y%m%d).dump

# Clean up old backups (>30 days)
find . -name "backup_*.dump" -mtime +30 -delete
```

**File Storage Backups:**

- Supabase Storage has built-in redundancy
- Optional: Mirror critical files to Cloudflare R2

### 6.2 Disaster Recovery Procedures

**Scenario 1: Database Corruption**

1. **Stop all writes:**

   ```typescript
   // Enable maintenance mode
   // Redirect all traffic to static maintenance page
   ```

2. **Assess damage:**

   ```sql
   -- Check for corrupted tables
   SELECT * FROM pg_stat_database;
   ```

3. **Restore from backup:**

   ```bash
   # Restore from latest backup
   pg_restore -h db.xxx.supabase.co -U postgres -d postgres backup.dump
   ```

4. **Verify data integrity:**

   ```sql
   -- Run data validation queries
   SELECT COUNT(*) FROM users;
   SELECT COUNT(*) FROM orders WHERE payment_status = 'completed';
   ```

5. **Resume operations:**
   - Disable maintenance mode
   - Monitor error rates closely

**Scenario 2: Complete Supabase Outage**

1. **Verify outage** (check Supabase status page)
2. **Enable read-only mode** (serve cached data)
3. **Communicate** (status page, social media)
4. **Queue writes** (store in Redis, replay when back online)
5. **Escalate** to Supabase enterprise support

**Scenario 3: Vercel Outage**

1. **Verify outage** (check Vercel status)
2. **Failover to Cloudflare Pages** (if configured)
3. **Update DNS** if prolonged outage
4. **Communicate** with users

**Recovery Time Objectives (RTO):**

- Database corruption: **<4 hours**
- Full platform outage: **<2 hours**
- Payment processing: **<1 hour**

**Recovery Point Objectives (RPO):**

- User data: **<1 hour** (PITR)
- Transactions: **<5 minutes** (logs + replay)
- Analytics: **<24 hours** (acceptable data loss)

---

## 7. Performance Optimization

### 7.1 Caching Strategy

**Edge Caching (Vercel):**

```typescript
// app/(public)/[username]/page.tsx
export const revalidate = 60 // Revalidate every 60 seconds (ISR)

export default async function StorefrontPage({ params }) {
  const { username } = params

  const supabase = createClient()
  const { data: creator } = await supabase
    .from('users')
    .select('*, products(*)')
    .eq('username', username)
    .single()

  return <Storefront creator={creator} />
}
```

**Browser Caching (Headers):**

```typescript
// next.config.js
{
  async headers() {
    return [
      {
        source: '/images/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable'
          }
        ]
      }
    ]
  }
}
```

**Redis Caching (Hot Data):**

```typescript
// lib/cache.ts
import { Redis } from '@upstash/redis'

const redis = Redis.fromEnv()

export async function getCachedStorefront(username: string) {
  const cached = await redis.get(`storefront:${username}`)

  if (cached) {
    return cached
  }

  const data = await fetchFromDatabase(username)

  await redis.setex(`storefront:${username}`, 300, data) // 5 min cache

  return data
}
```

### 7.2 Image Optimization

**Next.js Image Component:**

```typescript
import Image from 'next/image'

<Image
  src={product.coverImageUrl}
  alt={product.title}
  width={800}
  height={600}
  quality={80}
  placeholder="blur"
  blurDataURL={product.blurHash}
  sizes="(max-width: 768px) 100vw, 800px"
  priority={index < 2} // Prioritize first 2 images
/>
```

**Automatic Optimizations:**

- WebP/AVIF conversion
- Responsive images (srcset)
- Lazy loading
- CDN delivery

### 7.3 Database Query Optimization

**Add Indexes for Common Queries:**

```sql
-- Products by creator (most common query)
CREATE INDEX idx_products_creator_status ON products(creator_id, status);

-- Orders by creator and date
CREATE INDEX idx_orders_creator_created ON orders(creator_id, created_at DESC);

-- Analyze query performance
EXPLAIN ANALYZE
SELECT * FROM products
WHERE creator_id = 'xxx'
  AND status = 'active';
```

**Use Database Functions for Complex Queries:**

```sql
-- Instead of N+1 queries, create a function
CREATE OR REPLACE FUNCTION get_creator_dashboard_stats(creator_uuid UUID)
RETURNS JSON AS $$
  SELECT json_build_object(
    'total_revenue', COALESCE(SUM(amount), 0),
    'total_sales', COUNT(*),
    'avg_order_value', COALESCE(AVG(amount), 0)
  )
  FROM orders
  WHERE creator_id = creator_uuid
    AND payment_status = 'completed';
$$ LANGUAGE sql;
```

---

## 8. Incident Response Runbook

### 8.1 Payment Processing Down

**Symptoms:**

- Payment webhooks failing
- Orders stuck in "pending"
- Telebirr API errors

**Actions:**

1. Check Telebirr status: https://status.telebirr.et
2. Verify webhook endpoint accessible: `curl https://fabrica.et/api/webhooks/telebirr/health`
3. Check recent deployments (rollback if recent)
4. Review Sentry for errors
5. Check rate limits not exceeded
6. Verify webhook signature secret correct
7. Enable Chapa fallback if prolonged

**Communication Template:**

```
We're investigating payment processing issues.
New purchases may be delayed. We're working on a fix.
Updates: https://status.fabrica.et
```

### 8.2 Database Performance Degradation

**Symptoms:**

- Slow API responses
- Timeouts
- High CPU usage in Supabase dashboard

**Actions:**

1. Check active connections: `SELECT count(*) FROM pg_stat_activity;`
2. Identify slow queries: `SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;`
3. Kill long-running queries if needed: `SELECT pg_cancel_backend(pid);`
4. Check for missing indexes
5. Scale database if needed (Supabase dashboard)
6. Enable query logging for analysis

### 8.3 Complete Site Down

**Symptoms:**

- All users report errors
- Uptime monitors failing
- 500 errors

**Actions:**

1. Check Vercel status
2. Check Supabase status
3. Review recent deployments â†’ **Rollback immediately**
4. Check error rates in Sentry
5. Verify environment variables
6. Check DNS configuration
7. Enable maintenance mode if needed

**Rollback Command:**

```bash
# Instant rollback to previous deployment
vercel rollback fabrica-xxx-yyy.vercel.app --prod
```

---

## 9. Deployment Commands Reference

### Quick Commands

```bash
# Local development
npm run dev

# Build for production
npm run build

# Start production server locally
npm start

# Run tests
npm test
npm run test:e2e

# Lint and type check
npm run lint
npm run type-check

# Deploy to production (via Vercel CLI)
vercel --prod

# View deployment logs
vercel logs fabrica.et

# Rollback deployment
vercel rollback

# Run database migration
npx supabase db push

# Generate TypeScript types from database
npx supabase gen types typescript --local > types/database.types.ts
```

---

## 10. Post-Launch Checklist

**Week 1:**

- [ ] Monitor error rates daily
- [ ] Review payment success rate
- [ ] Check user signup funnel
- [ ] Respond to support tickets <2 hours
- [ ] Daily team standup

**Week 2:**

- [ ] Analyze user behavior (PostHog)
- [ ] Identify drop-off points
- [ ] Optimize slow queries
- [ ] Fix top 10 reported bugs

**Week 3:**

- [ ] Review infrastructure costs
- [ ] Optimize for cost savings
- [ ] Plan Phase 2 features
- [ ] Conduct user interviews

**Week 4:**

- [ ] Monthly security review
- [ ] Update dependencies
- [ ] Review and improve documentation
- [ ] Celebrate success! ðŸŽ‰

---

## Document Status

**Version:** 1.0  
**Last Updated:** November 19, 2025  
**Status:** âœ… Production-Ready  
**Maintainer:** Fabrica DevOps Team  
**Next Review:** February 19, 2026
