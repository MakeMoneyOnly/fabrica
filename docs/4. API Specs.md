# Fabrica - Complete API Specification

**Version:** 1.0  
**Last Updated:** November 19, 2025  
**Base URL:** `https://api.fabrica.et` (Production) / `http://localhost:3000` (Development)  
**Authentication:** Clerk JWT Tokens

---

## 1. Overview

This document defines all REST API endpoints for Fabrica, including request/response formats, authentication requirements, error codes, and rate limits.

### API Design Principles

1. **RESTful:** Standard HTTP methods (GET, POST, PATCH, DELETE)
2. **JSON Only:** All requests and responses in JSON format
3. **Stateless:** No server-side session storage
4. **Versioned:** API version in URL path (`/api/v1/...`)
5. **Consistent:** Uniform response structure across all endpoints
6. **Secure:** Authentication required for sensitive operations

### Standard Response Format

**Success:**

```json
{
  "success": true,
  "data": {
    // Response data here
  },
  "meta": {
    "timestamp": "2025-01-19T10:00:00Z",
    "requestId": "req_abc123"
  }
}
```

**Error:**

```json
{
  "success": false,
  "error": {
    "code": "RESOURCE_NOT_FOUND",
    "message": "Product not found",
    "details": {
      "productId": "prod_123"
    }
  },
  "meta": {
    "timestamp": "2025-01-19T10:00:00Z",
    "requestId": "req_abc123"
  }
}
```

**Paginated List:**

```json
{
  "success": true,
  "data": [...],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 157,
    "totalPages": 8,
    "hasNext": true,
    "hasPrev": false
  },
  "meta": {
    "timestamp": "2025-01-19T10:00:00Z"
  }
}
```

---

## 2. Authentication

### Headers Required

```http
Authorization: Bearer {clerk_jwt_token}
Content-Type: application/json
```

### Getting JWT Token (Client-Side)

```typescript
import { useAuth } from '@clerk/nextjs'

const { getToken } = useAuth()
const token = await getToken()

fetch('/api/products', {
  headers: {
    Authorization: `Bearer ${token}`,
    'Content-Type': 'application/json',
  },
})
```

### Rate Limits

| Endpoint Type             | Rate Limit   | Window     |
| ------------------------- | ------------ | ---------- |
| Public (Storefronts)      | 100 req/min  | Per IP     |
| Authenticated (Dashboard) | 200 req/min  | Per user   |
| Payment Endpoints         | 10 req/hour  | Per user   |
| Webhooks                  | 1000 req/min | Per source |

---

## 3. User Management APIs

### 3.1 Get Current User

**Endpoint:** `GET /api/users/me`  
**Auth Required:** Yes  
**Description:** Get current authenticated user profile

**Response:**

```json
{
  "success": true,
  "data": {
    "id": "usr_abc123",
    "email": "creator@example.com",
    "username": "creator",
    "fullName": "Abeba Tesfa",
    "avatarUrl": "https://cdn.fabrica.et/avatars/abc123.jpg",
    "bio": "Ethiopian fitness coach",
    "socialLinks": {
      "instagram": "https://instagram.com/creator",
      "tiktok": "https://tiktok.com/@creator"
    },
    "subscriptionPlan": "creator_pro",
    "subscriptionStatus": "active",
    "trialEndsAt": null,
    "totalRevenue": 15299.5,
    "totalSales": 87,
    "referralCode": "ABEBA123",
    "createdAt": "2025-01-01T10:00:00Z"
  }
}
```

**Error Codes:**

- `401` - Unauthorized (no valid token)

---

### 3.2 Update User Profile

**Endpoint:** `PATCH /api/users/me`  
**Auth Required:** Yes

**Request Body:**

```json
{
  "fullName": "Abeba Tesfa Updated",
  "bio": "New bio text",
  "avatarUrl": "https://cdn.fabrica.et/avatars/new.jpg",
  "socialLinks": {
    "instagram": "https://instagram.com/newhandle"
  }
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "id": "usr_abc123"
    // ... updated user object
  }
}
```

**Validation Rules:**

- `fullName`: 2-100 characters
- `bio`: Max 160 characters
- `socialLinks`: Valid URLs only

**Error Codes:**

- `400` - Invalid input
- `401` - Unauthorized
- `409` - Username already taken

---

### 3.3 Check Username Availability

**Endpoint:** `GET /api/users/check-username?username=abeba`  
**Auth Required:** No  
**Rate Limit:** 30 req/min

**Response:**

```json
{
  "success": true,
  "data": {
    "username": "abeba",
    "available": false,
    "suggestions": ["abeba1", "abeba_et", "abeba_coach"]
  }
}
```

---

## 4. Product Management APIs

### 4.1 List Products

**Endpoint:** `GET /api/products`  
**Auth Required:** Yes  
**Description:** List current user's products

**Query Parameters:**

```
?page=1
&limit=20
&status=active,draft
&type=digital,booking
&sort=created_at
&order=desc
&search=coffee
```

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "id": "prod_123",
      "type": "digital",
      "title": "Ethiopian Coffee Guide",
      "description": "Complete brewing guide",
      "coverImageUrl": "https://cdn.fabrica.et/products/123.jpg",
      "price": 299.99,
      "currency": "ETB",
      "status": "active",
      "viewsCount": 1247,
      "salesCount": 43,
      "revenueTotal": 12899.57,
      "conversionRate": 3.45,
      "createdAt": "2025-01-15T10:00:00Z",
      "publishedAt": "2025-01-15T12:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 5,
    "totalPages": 1
  }
}
```

---

### 4.2 Get Product Details

**Endpoint:** `GET /api/products/:id`  
**Auth Required:** Yes (owner) or No (if active and accessing public storefront)

**Response:**

```json
{
  "success": true,
  "data": {
    "id": "prod_123",
    "creatorId": "usr_abc123",
    "type": "digital",
    "title": "Ethiopian Coffee Guide",
    "description": "Complete guide...",
    "coverImageUrl": "https://cdn.fabrica.et/products/123.jpg",
    "price": 299.99,
    "currency": "ETB",
    "status": "active",
    "fileUrl": "https://storage.supabase.co/...", // Only if owner
    "fileSize": 52428800, // 50MB
    "fileType": "application/pdf",
    "downloadLimit": 3,
    "viewsCount": 1247,
    "salesCount": 43,
    "revenueTotal": 12899.57,
    "conversionRate": 3.45,
    "createdAt": "2025-01-15T10:00:00Z"
  }
}
```

**Error Codes:**

- `404` - Product not found
- `403` - Not authorized to view this product

---

### 4.3 Create Product

**Endpoint:** `POST /api/products`  
**Auth Required:** Yes  
**Rate Limit:** 20 req/hour

**Request Body (Digital Product):**

```json
{
  "type": "digital",
  "title": "Ethiopian Coffee Guide",
  "description": "Complete brewing guide for Ethiopian coffee",
  "price": 299.99,
  "coverImageUrl": "https://cdn.fabrica.et/temp/upload_123.jpg",
  "fileUrl": "https://storage.supabase.co/product-files/abc123.pdf",
  "fileSize": 52428800,
  "fileType": "application/pdf",
  "fileName": "coffee-guide.pdf",
  "downloadLimit": 3,
  "status": "draft" // or "active"
}
```

**Request Body (Booking):**

```json
{
  "type": "booking",
  "title": "30-Min Business Coaching",
  "description": "One-on-one coaching session",
  "price": 999.0,
  "durationMinutes": 30,
  "bookingType": "zoom",
  "calendarSettings": {
    "timezone": "Africa/Addis_Ababa",
    "bufferMinutes": 15,
    "maxBookingsPerDay": 8,
    "availableDays": [1, 2, 3, 4, 5], // Mon-Fri
    "availableHours": {
      "start": "09:00",
      "end": "17:00"
    }
  },
  "bookingInstructions": "I'll send Zoom link via email",
  "status": "active"
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "id": "prod_456",
    "slug": "ethiopian-coffee-guide-abc123"
    // ... full product object
  }
}
```

**Validation Rules:**

- `title`: 3-100 characters, required
- `description`: Max 1000 characters
- `price`: 10-100,000 ETB
- `fileSize`: Max 500MB for digital products
- `durationMinutes`: [15, 30, 45, 60, 90, 120] for bookings

**Error Codes:**

- `400` - Validation error
- `401` - Unauthorized
- `402` - Payment required (exceeded plan limits)
- `413` - File too large

---

### 4.4 Update Product

**Endpoint:** `PATCH /api/products/:id`  
**Auth Required:** Yes (owner only)

**Request Body:**

```json
{
  "title": "Updated Title",
  "price": 349.99,
  "status": "active"
}
```

**Response:** Same as Get Product

**Error Codes:**

- `404` - Product not found
- `403` - Not your product
- `400` - Validation error

---

### 4.5 Delete Product

**Endpoint:** `DELETE /api/products/:id`  
**Auth Required:** Yes (owner only)

**Response:**

```json
{
  "success": true,
  "data": {
    "id": "prod_123",
    "deleted": true
  }
}
```

**Note:** Soft delete (sets status to "archived")

---

### 4.6 Upload Product File

**Endpoint:** `POST /api/uploads/product-file`  
**Auth Required:** Yes  
**Content-Type:** `multipart/form-data`  
**Rate Limit:** 10 uploads/hour

**Request:**

```http
POST /api/uploads/product-file
Content-Type: multipart/form-data

file: [binary data]
```

**Response:**

```json
{
  "success": true,
  "data": {
    "url": "https://storage.supabase.co/product-files/usr_abc/1705660800000-guide.pdf",
    "path": "usr_abc/1705660800000-guide.pdf",
    "size": 52428800,
    "type": "application/pdf",
    "fileName": "guide.pdf"
  }
}
```

**Validation:**

- Max size: 500MB
- Allowed types: PDF, MP4, MP3, ZIP, JPEG, PNG, DOCX, XLSX

**Error Codes:**

- `413` - File too large
- `415` - Unsupported file type
- `507` - Storage quota exceeded

---

## 5. Order Management APIs

### 5.1 List Orders

**Endpoint:** `GET /api/orders`  
**Auth Required:** Yes (creator only)

**Query Parameters:**

```
?page=1
&limit=20
&status=completed,pending,failed
&startDate=2025-01-01
&endDate=2025-01-31
&search=customer@email.com
```

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "id": "ord_123",
      "orderNumber": "FAB-20250119-0001",
      "productId": "prod_456",
      "productTitle": "Ethiopian Coffee Guide",
      "productType": "digital",
      "customerEmail": "customer@example.com",
      "customerName": "Daniel Kebede",
      "customerPhone": "+251911223344",
      "amount": 299.99,
      "currency": "ETB",
      "paymentProvider": "chapa",
      "paymentStatus": "completed",
      "paymentProviderId": "TBR_20250119_XXXX",
      "paidAt": "2025-01-19T10:30:00Z",
      "createdAt": "2025-01-19T10:25:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 87
  }
}
```

---

### 5.2 Get Order Details

**Endpoint:** `GET /api/orders/:id`  
**Auth Required:** Yes (creator/owner only)

**Response:**

```json
{
  "success": true,
  "data": {
    "id": "ord_123",
    "orderNumber": "FAB-20250119-0001",
    "product": {
      "id": "prod_456",
      "title": "Ethiopian Coffee Guide",
      "type": "digital"
    },
    "customer": {
      "email": "customer@example.com",
      "name": "Daniel Kebede",
      "phone": "+251911223344"
    },
    "payment": {
      "amount": 299.99,
      "currency": "ETB",
      "provider": "chapa",
      "providerId": "TBR_20250119_XXXX",
      "status": "completed",
      "paidAt": "2025-01-19T10:30:00Z"
    },
    "fulfillment": {
      "status": "fulfilled",
      "fulfilledAt": "2025-01-19T10:30:05Z",
      "downloadLink": "https://fabrica.et/download/token_abc123" // If digital product
    },
    "metadata": {
      "ipAddress": "196.188.1.1",
      "userAgent": "Mozilla/5.0...",
      "referrer": "https://instagram.com"
    },
    "createdAt": "2025-01-19T10:25:00Z"
  }
}
```

---

### 5.3 Refund Order

**Endpoint:** `POST /api/orders/:id/refund`  
**Auth Required:** Yes (creator/owner only)  
**Rate Limit:** 10 req/hour

**Request Body:**

```json
{
  "reason": "Customer requested refund"
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "orderId": "ord_123",
    "refundStatus": "processing",
    "refundAmount": 299.99,
    "refundedAt": "2025-01-19T11:00:00Z",
    "message": "Refund will be processed within 5-10 business days"
  }
}
```

**Error Codes:**

- `404` - Order not found
- `403` - Not your order
- `400` - Order already refunded
- `400` - Order too old (>30 days)

---

## 6. Payment APIs

### 6.1 Initiate Payment

**Endpoint:** `POST /api/payments/initiate`  
**Auth Required:** No (guest checkout allowed)  
**Rate Limit:** 10 req/hour per IP

**Request Body:**

```json
{
  "productId": "prod_456",
  "customerEmail": "customer@example.com",
  "customerName": "Daniel Kebede",
  "customerPhone": "+251911223344",
  "bookingDatetime": "2025-01-25T14:00:00Z", // Only for booking products
  "discountCode": "LAUNCH20" // Optional
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "orderId": "ord_789",
    "orderNumber": "FAB-20250119-0002",
    "paymentUrl": "https://checkout.chapa.co/checkout/payment/xxxxx",
    "expiresAt": "2025-01-19T11:00:00Z" // 30 min timeout
  }
}
```

**Validation:**

- `customerEmail`: Valid email format
- `customerPhone`: Ethiopian phone format (+251...)
- `bookingDatetime`: Future date, within available slots

**Error Codes:**

- `404` - Product not found
- `400` - Invalid input
- `409` - Booking slot unavailable
- `400` - Invalid discount code

---

### 6.2 Verify Payment Status

**Endpoint:** `GET /api/payments/:orderId/status`  
**Auth Required:** No  
**Rate Limit:** 60 req/hour

**Response:**

```json
{
  "success": true,
  "data": {
    "orderId": "ord_789",
    "orderNumber": "FAB-20250119-0002",
    "paymentStatus": "completed", // pending, completed, failed
    "paidAt": "2025-01-19T10:30:00Z",
    "downloadUrl": "https://fabrica.et/download/token_xyz" // If completed + digital
  }
}
```

---

## 7. Analytics APIs

### 7.1 Get Dashboard Overview

**Endpoint:** `GET /api/analytics/overview`  
**Auth Required:** Yes  
**Query Parameters:** `?period=7d` (7d, 30d, 90d, all)

**Response:**

```json
{
  "success": true,
  "data": {
    "revenue": {
      "total": 15299.5,
      "period": 2899.0,
      "change": 15.3, // % change vs previous period
      "currency": "ETB"
    },
    "sales": {
      "total": 87,
      "period": 14,
      "change": 12.0
    },
    "views": {
      "total": 5420,
      "period": 1247,
      "change": 8.5
    },
    "conversionRate": {
      "current": 3.45,
      "change": 0.3
    },
    "topProducts": [
      {
        "id": "prod_456",
        "title": "Ethiopian Coffee Guide",
        "sales": 43,
        "revenue": 12899.57
      }
    ]
  }
}
```

---

### 7.2 Get Revenue Chart Data

**Endpoint:** `GET /api/analytics/revenue-chart`  
**Auth Required:** Yes  
**Query Parameters:** `?period=30d&interval=daily`

**Response:**

```json
{
  "success": true,
  "data": {
    "period": "30d",
    "interval": "daily",
    "dataPoints": [
      {
        "date": "2025-01-01",
        "revenue": 599.98,
        "orderCount": 2
      },
      {
        "date": "2025-01-02",
        "revenue": 1199.96,
        "orderCount": 4
      }
      // ... 30 data points
    ],
    "summary": {
      "totalRevenue": 15299.5,
      "averageDaily": 509.98,
      "totalOrders": 87
    }
  }
}
```

---

## 8. Storefront APIs (Public)

### 8.1 Get Storefront by Username

**Endpoint:** `GET /api/storefront/:username`  
**Auth Required:** No  
**Cache:** ISR 60 seconds

**Response:**

```json
{
  "success": true,
  "data": {
    "creator": {
      "username": "abeba",
      "fullName": "Abeba Tesfa",
      "avatarUrl": "https://cdn.fabrica.et/avatars/123.jpg",
      "bio": "Ethiopian fitness coach",
      "socialLinks": {
        "instagram": "https://instagram.com/abeba"
      }
    },
    "products": [
      {
        "id": "prod_456",
        "type": "digital",
        "title": "Ethiopian Coffee Guide",
        "description": "...",
        "coverImageUrl": "...",
        "price": 299.99,
        "currency": "ETB"
      }
    ],
    "theme": {
      "primaryColor": "#000000",
      "layout": "grid"
    }
  }
}
```

**Error Codes:**

- `404` - Creator not found
- `403` - Creator account suspended

---

### 8.2 Track Storefront Visit

**Endpoint:** `POST /api/analytics/track-visit`  
**Auth Required:** No  
**Rate Limit:** 100 req/min per IP

**Request Body:**

```json
{
  "username": "abeba",
  "productId": "prod_456", // Optional
  "referrer": "https://instagram.com",
  "sessionId": "sess_abc123"
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "tracked": true
  }
}
```

---

## 9. Referral APIs

### 9.1 Get Referral Stats

**Endpoint:** `GET /api/referrals/stats`  
**Auth Required:** Yes

**Response:**

```json
{
  "success": true,
  "data": {
    "referralCode": "ABEBA123",
    "referralLink": "https://fabrica.et?ref=ABEBA123",
    "totalReferrals": 12,
    "activeReferrals": 8,
    "totalEarned": 1920.0, // ETB
    "pendingEarnings": 480.0,
    "conversionRate": 66.67, // %
    "referrals": [
      {
        "referredUserId": "usr_xyz",
        "referredUsername": "daniel",
        "status": "active",
        "subscriptionPlan": "creator",
        "monthlyCommission": 180.0, // 20% of 899 ETB
        "totalEarned": 540.0,
        "signedUpAt": "2025-01-10T10:00:00Z",
        "convertedAt": "2025-01-11T14:30:00Z"
      }
    ]
  }
}
```

---

## 10. Admin APIs

### 10.1 List All Creators

**Endpoint:** `GET /api/admin/creators`  
**Auth Required:** Yes (Admin only)  
**Query Parameters:** `?page=1&limit=50&status=active&plan=creator_pro`

**Response:**

```json
{
  "success": true,
  "data": [
    {
      "id": "usr_abc",
      "username": "abeba",
      "email": "abeba@example.com",
      "fullName": "Abeba Tesfa",
      "subscriptionPlan": "creator_pro",
      "subscriptionStatus": "active",
      "totalRevenue": 15299.5,
      "totalSales": 87,
      "productsCount": 5,
      "status": "active",
      "createdAt": "2025-01-01T10:00:00Z",
      "lastActiveAt": "2025-01-19T09:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 50,
    "total": 1247
  }
}
```

---

### 10.2 Suspend Creator

**Endpoint:** `POST /api/admin/creators/:id/suspend`  
**Auth Required:** Yes (Admin only)

**Request Body:**

```json
{
  "reason": "Policy violation",
  "duration": "30d" // or "permanent"
}
```

**Response:**

```json
{
  "success": true,
  "data": {
    "userId": "usr_abc",
    "status": "suspended",
    "suspendedUntil": "2025-02-18T10:00:00Z",
    "reason": "Policy violation"
  }
}
```

---

## 11. Webhook Endpoints

### 11.1 Chapa Payment Webhook

**Endpoint:** `POST /api/webhooks/chapa`  
**Auth:** Signature verification (Chapa-Signature header)  
**Rate Limit:** 1000 req/min

**Request Body:**

```json
{
  "outTradeNo": "FAB-20250119-0001",
  "transactionId": "TBR_20250119_XXXX",
  "tradeStatus": "SUCCESS",
  "amount": "299.99",
  "paidAt": "2025-01-19T10:30:00Z",
  "sign": "abc123..."
}
```

**Response:**

```json
{
  "success": true,
  "message": "Webhook processed"
}
```

**Processing:**

1. Verify signature
2. Check idempotency (prevent duplicate processing)
3. Update order status
4. Generate download link (if digital product)
5. Send confirmation email
6. Return 200 OK

---

### 11.2 Clerk User Sync Webhook

**Endpoint:** `POST /api/webhooks/clerk`  
**Auth:** Svix signature verification

**Events Handled:**

- `user.created`
- `user.updated`
- `user.deleted`

**Processing:**

- Sync user data to Supabase `users` table
- Generate referral code on creation
- Handle subscription status changes

---

## 12. Error Codes Reference

| Code                  | HTTP | Meaning                          |
| --------------------- | ---- | -------------------------------- |
| `UNAUTHORIZED`        | 401  | Missing or invalid auth token    |
| `FORBIDDEN`           | 403  | Not authorized for this resource |
| `NOT_FOUND`           | 404  | Resource doesn't exist           |
| `VALIDATION_ERROR`    | 400  | Invalid input data               |
| `DUPLICATE`           | 409  | Resource already exists          |
| `RATE_LIMIT_EXCEEDED` | 429  | Too many requests                |
| `FILE_TOO_LARGE`      | 413  | File exceeds size limit          |
| `PAYMENT_FAILED`      | 402  | Payment processing error         |
| `INTERNAL_ERROR`      | 500  | Server error                     |

---

## 13. Testing

### Postman Collection

Import this collection for testing:

```json
{
  "info": {
    "name": "Fabrica API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "bearer",
    "bearer": [
      {
        "key": "token",
        "value": "{{clerk_token}}",
        "type": "string"
      }
    ]
  },
  "item": [
    {
      "name": "Users",
      "item": [
        {
          "name": "Get Current User",
          "request": {
            "method": "GET",
            "url": "{{base_url}}/api/users/me"
          }
        }
      ]
    }
  ]
}
```

---

## Document Status

**Version:** 1.0  
**Last Updated:** November 19, 2025  
**Status:** âœ… Complete  
**Maintainer:** Fabrica Engineering Team
