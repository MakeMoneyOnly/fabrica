# Fabrica - Chapa Payment Integration Guide

**Version:** 2.0  
**Last Updated:** November 22, 2025  
**Integration Type:** RESTful API  
**Primary Market:** Ethiopia  
**Official Documentation:** https://developer.chapa.co/

---

## 1. Overview

This document provides a comprehensive guide for integrating Chapa payment processing into Fabrica, including API specifications, security implementation, error handling, and testing procedures.

### What is Chapa?

Chapa is Ethiopia's leading payment gateway that provides a unified API for accepting payments through multiple methods including Telebirr, mobile money, bank transfers, and cards. Chapa offers comprehensive documentation, official SDKs, and a developer-friendly portal, making it easier to integrate than direct payment provider APIs.

### Why Chapa?

1. **Better Documentation:** Comprehensive guides, sample code, and clear API references
2. **Official SDKs:** Available for multiple languages (JavaScript, Python, Dart, etc.)
3. **Multiple Payment Methods:** Supports Telebirr, M-Pesa, bank transfers, and cards through a single API
4. **Developer Portal:** Dedicated dashboard with testing tools and clear setup steps
5. **Simpler Authentication:** Bearer token authentication (simpler than signature-based auth)
6. **Webhook Support:** Reliable webhook system with signature verification

### Integration Goals

1. **Seamless Payment Flow:** One-click checkout experience
2. **Security:** PCI-compliant, encrypted transactions with webhook signature verification
3. **Reliability:** Fallback mechanisms for failed transactions
4. **Ethiopian UX:** Optimized for Ethiopian users and network conditions
5. **Webhook Processing:** Real-time payment confirmations
6. **Multiple Payment Methods:** Support for Telebirr and other payment options through Chapa

---

## 2. Prerequisites

### 2.1 Requirements

**Business Requirements:**

- Registered Ethiopian business entity
- Chapa merchant account
- Valid TIN (Tax Identification Number)
- Business bank account

**Technical Requirements:**

- HTTPS-enabled domain (required for webhooks)
- Server with Node.js/TypeScript support
- Database for transaction logging
- Webhook endpoint capacity (handle 100+ req/min)

### 2.2 Account Setup

**Steps to Get Chapa Merchant Account:**

1. **Apply for Merchant Account:**
   - Visit [Chapa Dashboard](https://dashboard.chapa.co/)
   - Sign up for a developer account
   - Submit business documents (license, TIN, bank statements)
   - Complete KYC verification
   - Expected approval: 3-5 business days

2. **Receive API Credentials:**
   - Secret Key (Bearer token format: `CHASECK-xxxxx` for production or `CHASECK_TEST-xxxxx` for sandbox)
   - Webhook Secret (for verifying webhook signatures)
   - Access to Chapa Dashboard for transaction monitoring

3. **Test Environment Access:**
   - Test mode available immediately after signup
   - Test secret key (CHASECK_TEST-xxxxx)
   - Test phone numbers and cards for simulation
   - See [Testing Guide](https://developer.chapa.co/test/testing-mobile)

### 2.3 API Credentials Storage

```typescript
// .env.production
CHAPA_SECRET_KEY = CHASECK - your_production_secret_key_here
CHAPA_WEBHOOK_SECRET = your_webhook_secret_here

// .env.local (development)
CHAPA_SECRET_KEY = CHASECK_TEST - your_test_secret_key_here
CHAPA_WEBHOOK_SECRET = your_test_webhook_secret_here
```

**Security Notes:**

- Never commit secret keys to version control
- Use environment variables for all credentials
- Rotate keys regularly through Chapa Dashboard
- Use different keys for test and production environments

---

## 3. API Endpoints

### 3.1 Initiate Payment

**Endpoint:** `POST https://api.chapa.co/v1/transaction/initialize`

**Purpose:** Create a payment request and receive checkout URL

**Authentication:** Bearer token (`Authorization: Bearer CHASECK-xxxxx`)

**Request:**

```typescript
interface InitiatePaymentRequest {
  amount: string // Amount as string (e.g., "10")
  currency: string // Currency code (e.g., "ETB")
  email: string // Customer email (required)
  first_name: string // Customer first name (required)
  last_name: string // Customer last name (required)
  phone_number?: string // Customer phone (optional, format: 09xxxxxxxx or 07xxxxxxxx)
  tx_ref: string // Unique transaction reference (order ID) (required)
  callback_url: string // Webhook URL for payment notification (required)
  return_url: string // URL to redirect after payment (required)
  customization?: {
    title?: string // Custom checkout title
    description?: string // Custom checkout description
  }
}
```

**Response (Success):**

```json
{
  "status": "success",
  "message": "Payment initiated successfully",
  "data": {
    "checkout_url": "https://checkout.chapa.co/checkout/payment/xxxxx",
    "tx_ref": "order-123",
    "ref_id": "APqDvYw1okk2"
  }
}
```

**Response (Error):**

```json
{
  "status": "error",
  "message": "Invalid amount",
  "data": null
}
```

**Example Implementation:**

```typescript
import { getChapaClient } from '@/lib/payments/chapa'

const chapaClient = getChapaClient()
const result = await chapaClient.initiatePayment({
  orderId: 'order-123',
  amount: 299.99,
  subject: 'Product Purchase',
  customerName: 'John Doe',
  customerEmail: 'customer@example.com',
  customerPhone: '0912345678',
  returnUrl: 'https://yoursite.com/orders/order-123/success',
  notifyUrl: 'https://yoursite.com/api/webhooks/chapa',
})

if (result.success && result.paymentUrl) {
  // Redirect user to result.paymentUrl
}
```

**Documentation:** [Accept Payments](https://developer.chapa.co/integrations/accept-payments)

---

### 3.2 Verify Payment

**Endpoint:** `GET https://api.chapa.co/v1/transaction/verify/<tx_ref>`

**Purpose:** Verify payment status using transaction reference

**Authentication:** Bearer token (`Authorization: Bearer CHASECK-xxxxx`)

**Request:**

```typescript
// GET request with tx_ref as URL parameter
// Example: GET https://api.chapa.co/v1/transaction/verify/order-123
```

**Response (Success):**

```json
{
  "status": "success",
  "data": {
    "tx_ref": "order-123",
    "ref_id": "APqDvYw1okk2",
    "status": "successful",
    "amount": "299.99",
    "currency": "ETB",
    "created_at": "2025-01-19T10:30:00Z",
    "customer": {
      "email": "customer@example.com",
      "first_name": "John",
      "last_name": "Doe",
      "phone_number": "0912345678"
    }
  }
}
```

**Response (Error):**

```json
{
  "status": "error",
  "message": "Transaction not found"
}
```

**Example Implementation:**

```typescript
import { getChapaClient } from '@/lib/payments/chapa'

const chapaClient = getChapaClient()
const result = await chapaClient.verifyPayment('order-123')

if (result.success && result.status === 'SUCCESS') {
  // Payment confirmed
}
```

**Documentation:** [Verify Payments](https://developer.chapa.co/integrations/verify-payments)

---

### 3.3 Webhooks

**Endpoint:** `POST /api/webhooks/chapa` (your endpoint)

**Purpose:** Receive real-time payment notifications

**Signature Verification:**

Chapa sends webhook requests with a `Chapa-Signature` header containing an HMAC-SHA256 signature of the request body.

**Webhook Payload:**

```json
{
  "trx_ref": "order-123",
  "ref_id": "APqDvYw1okk2",
  "status": "success"
}
```

**Status Values:**

- `"success"` - Payment completed successfully
- `"failed"` - Payment failed
- `"pending"` - Payment is pending

**Signature Verification:**

```typescript
import crypto from 'crypto'

function verifyWebhookSignature(payload: string, signature: string): boolean {
  const webhookSecret = process.env.CHAPA_WEBHOOK_SECRET
  const expectedSignature = crypto.createHmac('sha256', webhookSecret).update(payload).digest('hex')

  return crypto.timingSafeEqual(
    Buffer.from(signature.toLowerCase()),
    Buffer.from(expectedSignature.toLowerCase())
  )
}
```

**Example Webhook Handler:**

```typescript
// src/app/api/webhooks/chapa/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { getChapaClient } from '@/lib/payments/chapa'

export async function POST(req: NextRequest) {
  const signature = req.headers.get('Chapa-Signature')
  if (!signature) {
    return new NextResponse('Missing signature', { status: 401 })
  }

  const payload = await req.text()
  const chapaClient = getChapaClient()

  if (!chapaClient.verifyWebhookSignature(payload, signature)) {
    return new NextResponse('Invalid signature', { status: 401 })
  }

  const webhookData = JSON.parse(payload)
  const { trx_ref, ref_id, status } = webhookData

  // Process payment status update
  if (status === 'success') {
    // Update order status to completed
  }

  return NextResponse.json({ message: 'Webhook received' })
}
```

**Documentation:** [Webhooks](https://developer.chapa.co/integrations/webhooks)

---

## 4. Implementation

### 4.1 TypeScript SDK

Our Chapa client implementation (`src/lib/payments/chapa.ts`):

```typescript
import { getChapaClient } from '@/lib/payments/chapa'

// Initialize payment
const chapaClient = getChapaClient()
const result = await chapaClient.initiatePayment({
  orderId: 'order-123',
  amount: 299.99,
  subject: 'Product Purchase',
  customerName: 'John Doe',
  customerEmail: 'customer@example.com',
  customerPhone: '0912345678',
  returnUrl: 'https://yoursite.com/success',
  notifyUrl: 'https://yoursite.com/api/webhooks/chapa',
})

// Verify payment
const verification = await chapaClient.verifyPayment('order-123')

// Verify webhook signature
const isValid = chapaClient.verifyWebhookSignature(payload, signature)
```

### 4.2 Payment Flow

1. **Customer initiates checkout:**
   - Customer selects product and enters details
   - Frontend calls `/api/payments/initiate`
   - Backend creates order and calls Chapa API
   - Backend returns checkout URL

2. **Customer completes payment:**
   - Customer redirected to Chapa checkout
   - Customer selects payment method (Telebirr, card, etc.)
   - Customer completes payment on Chapa platform

3. **Payment confirmation:**
   - Chapa sends webhook to `/api/webhooks/chapa`
   - Backend verifies webhook signature
   - Backend updates order status
   - Customer redirected to return URL

4. **Reconciliation:**
   - Use verify endpoint to check payment status
   - Reconcile transactions in Chapa Dashboard

---

## 5. Security

### 5.1 Authentication

- **Bearer Token:** Use `CHAPA_SECRET_KEY` as Bearer token in Authorization header
- **Never expose secret keys:** Keep keys in environment variables only
- **Key rotation:** Rotate keys regularly through Chapa Dashboard

### 5.2 Webhook Security

- **Always verify signatures:** Never process webhooks without signature verification
- **Use HTTPS:** Webhook endpoints must use HTTPS
- **Idempotency:** Handle duplicate webhook deliveries gracefully
- **Timeout handling:** Return 200 OK even on errors to prevent retries

### 5.3 Data Protection

- **Encrypt sensitive data:** Store payment data encrypted at rest
- **PCI Compliance:** Don't store full card details
- **Logging:** Log payment events without exposing sensitive data

**Documentation:** [Security Guide](https://developer.chapa.co/security/security-guide)

---

## 6. Error Handling

### 6.1 Common Error Codes

| Code               | Message                            | Solution              |
| ------------------ | ---------------------------------- | --------------------- |
| Invalid amount     | Amount must be positive            | Check amount value    |
| Invalid email      | Email format invalid               | Validate email format |
| Invalid tx_ref     | Transaction reference already used | Use unique order IDs  |
| Insufficient funds | Customer has insufficient balance  | Inform customer       |
| Network error      | API request failed                 | Implement retry logic |

**Documentation:** [Error Codes](https://developer.chapa.co/integrations/responses)

### 6.2 Retry Logic

```typescript
async function initiatePaymentWithRetry(params: InitiatePaymentParams, maxRetries = 3) {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const result = await chapaClient.initiatePayment(params)
      if (result.success) return result
    } catch (error) {
      if (attempt === maxRetries - 1) throw error
      await new Promise((resolve) => setTimeout(resolve, Math.pow(2, attempt) * 1000))
    }
  }
}
```

---

## 7. Testing

### 7.1 Test Mode

Chapa provides a test mode with test credentials:

- **Test Secret Key:** `CHASECK_TEST-xxxxx`
- **Test Cards:** See [Testing Cards](https://developer.chapa.co/test/testing-cards)
- **Test Mobile Numbers:** See [Testing Mobile](https://developer.chapa.co/test/testing-mobile)

### 7.2 Test Scenarios

1. **Successful Payment:**
   - Use test card: `4242 4242 4242 4242`
   - CVV: Any 3 digits
   - Expiry: Any future date

2. **Failed Payment:**
   - Use test card: `4000 0000 0000 0002`
   - Simulates declined card

3. **Webhook Testing:**
   - Use Chapa Dashboard webhook testing tool
   - Or use services like webhook.site for testing

**Documentation:** [Test Mode vs Live Mode](https://developer.chapa.co/integrations/test-mode-vs-live-mode)

---

## 8. Supported Payment Methods

Chapa supports multiple payment methods:

1. **Telebirr** - Mobile money (via Chapa)
2. **M-Pesa** - Mobile money
3. **Bank Transfer** - Direct bank transfers
4. **Cards** - Visa, Mastercard, etc.

All payment methods are handled through the same Chapa API, simplifying integration.

**Documentation:** [Supported Payment Methods](https://developer.chapa.co/payment-methods)

---

## 9. Monitoring & Analytics

### 9.1 Chapa Dashboard

Access transaction monitoring through [Chapa Dashboard](https://dashboard.chapa.co/):

- View all transactions
- Monitor payment status
- Download transaction reports
- Configure webhook URLs
- Manage API keys

### 9.2 Transaction Logs

Use Chapa's transaction logs API to:

- Query transaction history
- Reconcile payments
- Generate reports

**Documentation:** [Transaction Logs](https://developer.chapa.co/transactions/transaction-log)

---

## 10. Migration from Telebirr

If migrating from direct Telebirr integration:

1. **Update Environment Variables:**
   - Replace `TELEBIRR_*` variables with `CHAPA_SECRET_KEY` and `CHAPA_WEBHOOK_SECRET`
   - Remove `TELEBIRR_API_URL` (not needed)

2. **Update Code:**
   - Replace `TelebirrClient` with `ChapaClient`
   - Update webhook endpoint from `/api/webhooks/telebirr` to `/api/webhooks/chapa`
   - Update webhook signature header from `x-telebirr-signature` to `Chapa-Signature`

3. **Test Thoroughly:**
   - Test payment initiation
   - Test webhook handling
   - Verify payment status checks

---

## 11. Resources

- **Official Documentation:** https://developer.chapa.co/
- **Accept Payments:** https://developer.chapa.co/integrations/accept-payments
- **Verify Payments:** https://developer.chapa.co/integrations/verify-payments
- **Webhooks:** https://developer.chapa.co/integrations/webhooks
- **SDK and Plugins:** https://developer.chapa.co/integrations/sdk-plugins
- **Error Codes:** https://developer.chapa.co/integrations/responses
- **Security Guide:** https://developer.chapa.co/security/security-guide
- **Dashboard:** https://dashboard.chapa.co/
- **Support:** https://t.me/chapist_dev

---

## 12. Support

For issues or questions:

1. **Chapa Support:** Contact through Telegram: https://t.me/chapist_dev
2. **Documentation:** Check official docs at https://developer.chapa.co/
3. **Dashboard:** Access support through Chapa Dashboard

---

**Last Updated:** November 22, 2025  
**Version:** 2.0  
**Maintained by:** Fabrica Development Team
